<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Top 主機分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-6">
    <div id="root" class="max-w-4xl mx-auto"></div>

    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [report, setReport] = useState(null);
            const [error, setError] = useState(null);

            // 清理帳號名稱，移除組織層級資訊
            const cleanAccountName = (accountStr) => {
                if (!accountStr || accountStr === 'N/A') return '未關聯特定帳號/姓名';
                const match = accountStr.match(/^([\w\d\-\/]+)\s*(.*?\([^\)]+\))?\s*(\(.*\))?$/);
                if (match) {
                    const account = match[1].trim();
                    const name = match[2] ? match[2].trim() : '';
                    return `${account}${name}`;
                }
                return accountStr.trim();
            };

            // 處理 Excel 檔案
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets['Report2'];
                        if (!sheet) throw new Error('未找到 "Report2" 工作表');

                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        let dataRows = [];
                        let totalTraffic = 0;
                        let totalConnections = 0;

                        // 提取 Top主機 資料
                        for (let row of json) {
                            if (row[0] && !isNaN(row[0]) && Number.isInteger(Number(row[0]))) {
                                const ipInfo = row[1] ? String(row[1]).trim() : '';
                                const connections = Number(row[2]) || 0;
                                const ipMatch = ipInfo.match(/^(\d+\.\d+\.\d+\.\d+)(?:-([\w\d\-\/].*))?/);
                                if (ipMatch) {
                                    const ip = ipMatch[1];
                                    const account = ipMatch[2] || null;
                                    dataRows.push({
                                        ipAddress: ip,
                                        account: cleanAccountName(account),
                                        connections
                                    });
                                } else {
                                    dataRows.push({
                                        ipAddress: ipInfo,
                                        account: '未關聯特定帳號/姓名',
                                        connections
                                    });
                                }
                            }
                            if (row[0] === '總流量') totalTraffic = Number(row[1]) || 0;
                            if (row[0] === 'Total') totalConnections = Number(row[1]) || 0;
                        }

                        // 生成報表資料
                        setReport({
                            rows: dataRows,
                            totalTraffic,
                            totalConnections,
                            date: new Date().toISOString().split('T')[0]
                        });
                        setError(null);
                    } catch (err) {
                        setError(`處理檔案時出錯：${err.message}`);
                        setReport(null);
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h1 className="text-2xl font-bold mb-4">Excel Top 主機分析</h1>
                    <div className="mb-4">
                        <label htmlFor="file-upload" className="block text-sm font-medium text-gray-700 mb-2">
                            上傳 Excel 檔案
                        </label>
                        <input
                            id="file-upload"
                            type="file"
                            accept=".xls,.xlsx"
                            onChange={handleFileUpload}
                            className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                        />
                    </div>
                    {error && <p className="text-red-600 mb-4">{error}</p>}
                    {report && (
                        <div>
                            <h2 className="text-xl font-semibold mb-2">應用管理 Top 主機分析 - {report.date}</h2>
                            <p className="mb-4">以下是從 "Top主機" 部分提取的 IP 地址、帳號與姓名資訊及連線總數。</p>
                            <table className="w-full border-collapse border border-gray-300 mb-6">
                                <thead>
                                    <tr className="bg-gray-200">
                                        <th className="border border-gray-300 p-2">IP 地址</th>
                                        <th className="border border-gray-300 p-2">帳號與姓名資訊</th>
                                        <th className="border border-gray-300 p-2">連線總數</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {report.rows.map((row, index) => (
                                        <tr key={index}>
                                            <td className="border border-gray-300 p-2">{row.ipAddress}</td>
                                            <td className="border border-gray-300 p-2">{row.account}</td>
                                            <td className="border border-gray-300 p-2">{row.connections}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <h3 className="text-lg font-semibold mb-2">摘要</h3>
                            <ul className="list-disc pl-5">
                                <li><strong>總流量 (總流量):</strong> {report.totalTraffic}</li>
                                <li><strong>總連線數 (Total):</strong> {report.totalConnections}</li>
                                <li><strong>觀察:</strong>
                                    <ul className="list-circle pl-5">
                                        <li>IP <code>{report.rows[0].ipAddress}</code> (關聯於 {report.rows[0].account}) 擁有最高連線數 {report.rows[0].connections}。</li>
                                        <li>多個 IP (例如 <code>{report.rows.find(row => row.account === '未關聯特定帳號/姓名')?.ipAddress || 'N/A'}</code> 等) 未關聯特定帳號或姓名，可能為未分配或通用設備。</li>
                                        <li>前三個有帳號資訊的 IP 分別屬於 {report.rows.filter(row => row.account !== '未關聯特定帳號/姓名').slice(0, 3).map(row => row.account).join(', ')}，連線數分別為 {report.rows.filter(row => row.account !== '未關聯特定帳號/姓名').slice(0, 3).map(row => row.connections).join(', ')}。</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
