<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Top 主機分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 若 CDN 無法載入，可下載至倉庫的 libs 目錄並使用本地路徑 -->
    <!-- <script src="./libs/react.production.min.js"></script> -->
    <!-- <script src="./libs/react-dom.production.min.js"></script> -->
    <!-- <script src="./libs/babel.min.js"></script> -->
    <!-- <script src="./libs/xlsx.full.min.js"></script> -->
</head>
<body class="bg-gray-100 p-6">
    <div id="root" class="max-w-4xl mx-auto">
        <p class="text-gray-600">正在載入應用，請稍候...</p>
    </div>

    <script type="text/babel">
        // 全局錯誤處理
        window.onerror = function (message, source, lineno, colno, error) {
            console.error('全局錯誤:', { message, source, lineno, colno, error });
            const root = document.getElementById('root');
            root.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md text-red-600">
                    <h1 class="text-2xl font-bold mb-4">應用載入失敗</h1>
                    <p>錯誤訊息: ${message}</p>
                    <p>請檢查控制台日誌（F12 > Console）並聯繫支援。</p>
                </div>
            `;
            return true;
        };

        // 確認依賴是否載入
        if (!window.React || !window.ReactDOM || !window.XLSX || !window.Babel) {
            throw new Error('無法載入必要資源（React, ReactDOM, XLSX, 或 Babel）。請檢查網路連線或使用本地資源。');
        }

        const { useState } = React;

        function App() {
            const [report, setReport] = useState(null);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);
            const [sheetName, setSheetName] = useState('Report2');
            const [availableSheets, setAvailableSheets] = useState([]);
            const [file, setFile] = useState(null);

            // 清理帳號名稱
            const cleanAccountName = (accountStr) => {
                console.log('清理帳號:', accountStr);
                if (!accountStr || accountStr === 'N/A' || typeof accountStr !== 'string') {
                    return '未關聯特定帳號/姓名';
                }
                const match = accountStr.match(/^([\w\d\-\/]+.*?)(?:\s*\(.*\))?$/);
                return match ? match[1].trim() : accountStr.trim();
            };

            // 處理數字格式
            const parseNumber = (value) => {
                if (value === '' || value === null || value === undefined) return 0;
                if (typeof value === 'string') {
                    value = value.replace(/,/g, '');
                }
                return Number(value) || 0;
            };

            // 檢查標題行
            const isHeaderRow = (row) => {
                const first = String(row[0]).trim().toLowerCase();
                const second = String(row[1]).trim().toLowerCase();
                const third = String(row[2]).trim().toLowerCase();
                return (
                    first.includes('編號') &&
                    second.includes('主機') &&
                    third.includes('連線數')
                );
            };

            // 處理 Excel 檔案
            const handleFileUpload = (event) => {
                const selectedFile = event.target.files[0];
                if (!selectedFile) {
                    setError('請選擇一個 Excel 檔案');
                    setLoading(false);
                    return;
                }
                setFile(selectedFile);
                setLoading(true);
                setError(null);
                setReport(null);
                console.log('開始處理檔案:', selectedFile.name);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        console.log('檔案讀取完成，開始解析 Excel');
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('工作表列表:', workbook.SheetNames);

                        setAvailableSheets(workbook.SheetNames);
                        if (!sheetName && workbook.SheetNames.length > 0) {
                            setSheetName('Report2');
                        }

                        setLoading(false);
                    } catch (err) {
                        console.error('檔案讀取錯誤:', err);
                        setError('無法解析 Excel 檔案，請確保檔案格式為 .xls 或 .xlsx');
                        setLoading(false);
                    }
                };
                reader.onerror = () => {
                    setError('無法讀取檔案，請確保檔案格式正確');
                    setLoading(false);
                };
                reader.readAsArrayBuffer(file || selectedFile);
            };

            // 解析選定工作表
            const parseSheet = () => {
                if (!file) {
                    setError('請先上傳 Excel 檔案');
                    return;
                }
                if (!sheetName) {
                    setError('請選擇一個工作表');
                    return;
                }

                setLoading(true);
                setError(null);
                setReport(null);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        console.log('開始解析工作表:', sheetName);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[sheetName];
                        if (!sheet) {
                            throw new Error(`無法載入工作表: ${sheetName}`);
                        }

                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                        console.log('工作表轉為 JSON（前10行）:', json.slice(0, 10));

                        let dataRows = [];
                        let totalTraffic = 0;
                        let totalConnections = 0;
                        let foundData = false;
                        let errors = [];

                        for (let i = 0; i < json.length; i++) {
                            const row = json[i];
                            console.log(`處理第 ${i + 1} 行:`, row);

                            if (!row[0] && !row[1] && !row[2]) {
                                console.log(`第 ${i + 1} 行：空行，跳過`);
                                continue;
                            }

                            if (isHeaderRow(row)) {
                                console.log(`第 ${i + 1} 行：標題行，跳過`);
                                continue;
                            }

                            const rowNum = row[0] ? String(row[0]).trim() : '';
                            const ipInfo = row[1] ? String(row[1]).trim() : '';
                            const connections = parseNumber(row[2]);

                            if (row[0] === '總流量') {
                                totalTraffic = parseNumber(row[1]);
                                console.log('提取總流量:', totalTraffic);
                                continue;
                            }
                            if (row[0] === 'Total') {
                                totalConnections = parseNumber(row[1]);
                                console.log('提取總連線數:', totalConnections);
                                continue;
                            }

                            if (ipInfo && connections > 0) {
                                console.log('識別為資料行:', { rowNum, ipInfo, connections });
                                const ipMatch = ipInfo.match(/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?:-([\w\d\-\/].*))?/);
                                if (ipMatch) {
                                    const ip = ipMatch[1];
                                    const account = ipMatch[2] || null;
                                    dataRows.push({
                                        ipAddress: ip,
                                        account: cleanAccountName(account),
                                        connections
                                    });
                                } else {
                                    dataRows.push({
                                        ipAddress: ipInfo,
                                        account: '未關聯特定帳號/姓名',
                                        connections
                                    });
                                }
                                foundData = true;
                            } else {
                                errors.push(`第 ${i + 1} 行：無效（IP/帳號：${ipInfo}, 連線數：${row[2]}）`);
                            }
                        }

                        if (!foundData) {
                            let errorMsg = '未找到有效的 Top主機 資料。請確認：\n';
                            errorMsg += '- 資料包含 IP/帳號（例如 "10.101.16.195" 或 "10.101.16.195-帳號"）。\n';
                            errorMsg += '- 連線數為有效數字（例如 110）。\n';
                            errorMsg += '- 標題行格式為 "編號 主機 總連線數"。\n';
                            if (errors.length > 0) {
                                errorMsg += '- 以下行有問題：\n  ' + errors.join('\n  ');
                            }
                            throw new Error(errorMsg);
                        }

                        console.log('資料提取完成:', { dataRows, totalTraffic, totalConnections });

                        setReport({
                            rows: dataRows,
                            totalTraffic,
                            totalConnections,
                            date: new Date().toISOString().split('T')[0]
                        });
                        setLoading(false);
                    } catch (err) {
                        console.error('解析錯誤:', err);
                        setError(`處理工作表 "${sheetName}" 時出錯：${err.message}\n可用工作表：${availableSheets.join(', ')}`);
                        setLoading(false);
                    }
                };
                reader.onerror = () => {
                    setError('無法讀取檔案，請確保檔案格式正確');
                    setLoading(false);
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h1 className="text-2xl font-bold mb-4">Excel Top 主機分析</h1>
                    <div className="mb-4">
                        <label htmlFor="file-upload" className="block text-sm font-medium text-gray-700 mb-2">
                            上傳 Excel 檔案 (.xls 或 .xlsx)
                        </label>
                        <input
                            id="file-upload"
                            type="file"
                            accept=".xls,.xlsx"
                            onChange={handleFileUpload}
                            className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                        />
                    </div>
                    {availableSheets.length > 0 && (
                        <div className="mb-4">
                            <label htmlFor="sheet-name" className="block text-sm font-medium text-gray-700 mb-2">
                                選擇工作表
                            </label>
                            <select
                                id="sheet-name"
                                value={sheetName}
                                onChange={(e) => setSheetName(e.target.value)}
                                className="block w-full p-2 border border-gray-300 rounded-md"
                            >
                                {availableSheets.map((sheet) => (
                                    <option key={sheet} value={sheet}>
                                        {sheet}
                                    </option>
                                ))}
                            </select>
                            <button
                                onClick={parseSheet}
                                className="mt-2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                            >
                                解析工作表
                            </button>
                        </div>
                    )}
                    {loading && <p className="text-blue-600 mb-4">正在處理檔案，請稍候...</p>}
                    {error && (
                        <div className="text-red-600 mb-4 whitespace-pre-line">
                            <p>{error}</p>
                            <p className="mt-2">
                                請檢查 Excel 檔案格式，確保 "Top主機" 資料位於 "Report2"，包含 IP/帳號和連線數。
                                <br />
                                <a href="#" onClick={() => setError(null)} className="text-blue-600 underline">
                                    重新上傳
                                </a>
                            </p>
                        </div>
                    )}
                    {report && (
                        <div>
                            <h2 className="text-xl font-semibold mb-2">應用管理 Top 主機分析 - {report.date}</h2>
                            <p className="mb-4">以下是從 "Top主機" 部分提取的 IP 地址、帳號與姓名資訊及連線總數。</p>
                            <table className="w-full border-collapse border border-gray-300 mb-6">
                                <thead>
                                    <tr className="bg-gray-200">
                                        <th className="border border-gray-300 p-2">IP 地址</th>
                                        <th className="border border-gray-300 p-2">帳號與姓名資訊</th>
                                        <th className="border border-gray-300 p-2">連線總數</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {report.rows.map((row, index) => (
                                        <tr key={index}>
                                            <td className="border border-gray-300 p-2">{row.ipAddress}</td>
                                            <td className="border border-gray-300 p-2">{row.account}</td>
                                            <td className="border border-gray-300 p-2">{row.connections}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <h3 className="text-lg font-semibold mb-2">摘要</h3>
                            <ul className="list-disc pl-5">
                                <li><strong>總流量 (總流量):</strong> {report.totalTraffic}</li>
                                <li><strong>總連線數 (Total):</strong> {report.totalConnections}</li>
                                <li><strong>觀察:</strong>
                                    <ul className="list-circle pl-5">
                                        <li>IP <code>{report.rows[0].ipAddress}</code> (關聯於 {report.rows[0].account}) 擁有最高連線數 {report.rows[0].connections}。</li>
                                        <li>
                                            多個 IP (例如 <code>
                                            {report.rows.find(row => row.account === '未關聯特定帳號/姓名')?.ipAddress || 'N/A'}
                                            </code> 等) 未關聯特定帳號或姓名，可能為未分配或通用設備。
                                        </li>
                                        <li>
                                            前三個有帳號資訊的 IP 分別屬於{' '}
                                            {report.rows
                                                .filter(row => row.account !== '未關聯特定帳號/姓名')
                                                .slice(0, 3)
                                                .map(row => row.account)
                                                .join(', ') || '無'},
                                            連線數分別為{' '}
                                            {report.rows
                                                .filter(row => row.account !== '未關聯特定帳號/姓名')
                                                .slice(0, 3)
                                                .map(row => row.connections)
                                                .join(', ') || '無'}。
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    )}
                </div>
            );
        }

        // 使用 React 18 的 createRoot 渲染
        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        } catch (err) {
            console.error('渲染錯誤:', err);
            document.getElementById('root').innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md text-red-600">
                    <h1 class="text-2xl font-bold mb-4">應用渲染失敗</h1>
                    <p>錯誤訊息: ${err.message}</p>
                    <p>請檢查控制台日誌（F12 > Console）並聯繫支援。</p>
                </div>
            `;
        }
    </script>
</body>
</html>
