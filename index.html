<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Top 主機分析</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- 若 CDN 無法載入，可下載以下檔案至倉庫的 libs 目錄並使用本地路徑 -->
    <!-- <script src="./libs/react.production.min.js"></script> -->
    <!-- <script src="./libs/react-dom.production.min.js"></script> -->
    <!-- <script src="./libs/babel.min.js"></script> -->
    <!-- <script src="./libs/xlsx.full.min.js"></script> -->
</head>
<body class="bg-gray-100 p-6">
    <div id="root" class="max-w-4xl mx-auto"></div>

    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [report, setReport] = useState(null);
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);
            const [sheetName, setSheetName] = useState('Report2');
            const [availableSheets, setAvailableSheets] = useState([]);
            const [file, setFile] = useState(null);

            // 清理帳號名稱，移除組織層級資訊
            const cleanAccountName = (accountStr) => {
                console.log('清理帳號:', accountStr);
                if (!accountStr || accountStr === 'N/A' || typeof accountStr !== 'string') {
                    return '未關聯特定帳號/姓名';
                }
                // 放寬帳號提取，保留主要帳號和姓名
                const match = accountStr.match(/^([\w\d\-\/]+.*?)(?:\s*\(.*\))?$/);
                return match ? match[1].trim() : accountStr.trim();
            };

            // 處理數字格式（移除逗號，處理空值）
            const parseNumber = (value) => {
                if (value === '' || value === null || value === undefined) return 0;
                if (typeof value === 'string') {
                    value = value.replace(/,/g, '');
                }
                return Number(value) || 0;
            };

            // 檢查是否為標題行
            const isHeaderRow = (row) => {
                const first = String(row[0]).trim().toLowerCase();
                const second = String(row[1]).trim().toLowerCase();
                const third = String(row[2]).trim().toLowerCase();
                return (
                    first.includes('編號') &&
                    second.includes('主機') &&
                    third.includes('連線數')
                );
            };

            // 處理 Excel 檔案
            const handleFileUpload = (event) => {
                const selectedFile = event.target.files[0];
                if (!selectedFile) {
                    setError('請選擇一個 Excel 檔案');
                    setLoading(false);
                    return;
                }
                setFile(selectedFile);
                setLoading(true);
                setError(null);
                setReport(null);
                console.log('開始處理檔案:', selectedFile.name);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        console.log('檔案讀取完成，開始解析 Excel');
                        const workbook = XLSX.read(data, { type: 'array' });
                        console.log('工作表列表:', workbook.SheetNames);

                        // 更新可用工作表列表
                        setAvailableSheets(workbook.SheetNames);
                        if (!sheetName && workbook.SheetNames.length > 0) {
                            setSheetName('Report2'); // 預設 Report2
                        }

                        setLoading(false);
                    } catch (err) {
                        console.error('檔案讀取錯誤:', err);
                        setError('無法解析 Excel 檔案，請確保檔案格式為 .xls 或 .xlsx');
                        setLoading(false);
                    }
                };
                reader.onerror = () => {
                    setError('無法讀取檔案，請確保檔案格式正確');
                    setLoading(false);
                };
                reader.readAsArrayBuffer(file || selectedFile);
            };

            // 解析選定工作表
            const parseSheet = () => {
                if (!file) {
                    setError('請先上傳 Excel 檔案');
                    return;
                }
                if (!sheetName) {
                    setError('請選擇一個工作表');
                    return;
                }

                setLoading(true);
                setError(null);
                setReport(null);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        console.log('開始解析工作表:', sheetName);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[sheetName];
                        if (!sheet) {
                            throw new Error(`無法載入工作表: ${sheetName}`);
                        }

                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                        console.log('工作表轉為 JSON（前10行）:', json.slice(0, 10));

                        let dataRows = [];
                        let totalTraffic = 0;
                        let totalConnections = 0;
                        let foundData = false;
                        let errors = [];

                        // 提取 Top主機 資料
                        for (let i = 0; i < json.length; i++) {
                            const row = json[i];
                            console.log(`處理第 ${i + 1} 行:`, row);

                            // 跳過空行
                            if (!row[0] && !row[1] && !row[2]) {
                                console.log(`第 ${i + 1} 行：空行，跳過`);
                                continue;
                            }

                            // 跳過標題行
                            if (isHeaderRow(row)) {
                                console.log(`第 ${i + 1} 行：標題行，跳過`);
                                continue;
                            }

                            // 檢查是否為資料行
                            const rowNum = row[0] ? String(row[0]).trim() : '';
                            const ipInfo = row[1] ? String(row[1]).trim() : '';
                            const connections = parseNumber(row[2]);

                            // 檢查是否為總流量或 Total 行
                            if (row[0] === '總流量') {
                                totalTraffic = parseNumber(row[1]);
                                console.log('提取總流量:', totalTraffic);
                                continue;
                            }
                            if (row[0] === 'Total') {
                                totalConnections = parseNumber(row[1]);
                                console.log('提取總連線數:', totalConnections);
                                continue;
                            }

                            // 驗證資料行（需要 IP 和有效連線數）
                            if (ipInfo && connections > 0) {
                                console.log('識別為資料行:', { rowNum, ipInfo, connections });
                                // 放寬 IP 提取邏輯
                                const ipMatch = ipInfo.match(/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?:-([\w\d\-\/].*))?/);
                                if (ipMatch) {
                                    const ip = ipMatch[1];
                                    const account = ipMatch[2] || null;
                                    dataRows.push({
                                        ipAddress: ip,
                                        account: cleanAccountName(account),
                                        connections
                                    });
                                } else {
                                    // 如果無 IP 格式，視為純 IP 或其他主機
                                    dataRows.push({
                                        ipAddress: ipInfo,
                                        account: '未關聯特定帳號/姓名',
                                        connections
                                    });
                                }
                                foundData = true;
                            } else {
                                errors.push(`第 ${i + 1} 行：無效（IP/帳號：${ipInfo}, 連線數：${row[2]}）`);
                            }
                        }

                        if (!foundData) {
                            let errorMsg = '未找到有效的 Top主機 資料。請確認：\n';
                            errorMsg += '- 資料包含 IP/帳號（例如 "10.101.16.195" 或 "10.101.16.195-帳號"）。\n';
                            errorMsg += '- 連線數為有效數字（例如 110）。\n';
                            errorMsg += '- 標題行格式為 "編號 主機 總連線數"。\n';
                            if (errors.length > 0) {
                                errorMsg += '- 以下行有問題：\n  ' + errors.join('\n  ');
                            }
                            throw new Error(errorMsg);
                        }

                        console.log('資料提取完成:', { dataRows, totalTraffic, totalConnections });

                        // 生成報表資料
                        setReport({
                           簡介: 你的 Excel 檔案（`AFLog-20250508-010229.xls`）包含三個工作表：Report0（Top用戶）、Report1（Top中繼站）、Report2（Top主機）。本應用專為解析 "Report2" 的「Top主機」資料設計，顯示 IP 地址、帳號與姓名（排除組織層級資訊）、連線總數。

## 功能

- **上傳 Excel**：支援 `.xls` 或 `.xlsx` 檔案。
- **工作表選擇**：上傳後選擇工作表（預設 Report2）。
- **解析資料**：自動跳過標題行，提取 "Top主機" 的 IP、帳號、連線數。
- **生成報表**：顯示表格和摘要（總流量、總連線數、觀察）。
- **美化介面**：使用 Tailwind CSS，確保響應式和易讀。
- **錯誤處理**：詳細錯誤訊息，提示資料或工作表問題。

## 部署到 GitHub Pages

1. **創建倉庫**：
   - 在 GitHub 上創建一個新倉庫（例如 `excel-top-hosts-analysis`）。

2. **添加文件**：
   - 將 `index.html` 保存到倉庫根目錄。
   - 將此 `README.md` 添加到倉庫。

3. **推送到 GitHub**：
   ```bash
   git init
   git add index.html README.md
   git commit -m "修復 Top主機 資料解析，優化標題行和連線數處理"
   git branch -M main
   git remote add origin <你的倉庫URL>
   git push -u origin main
   ```

4. **啟用 GitHub Pages**：
   - 進入倉庫的 **Settings** > **Pages**。
   - 在 **Source** 下選擇 `main` 分支，資料夾選擇 `/ (root)`，點擊 **Save**。
   - 等待幾分鐘，訪問生成的 URL（例如 `https://<你的用戶名>.github.io/excel-top-hosts-analysis`）。

5. **訪問應用**：
   - 上傳 `AFLog-20250508-010229.xls`，選擇 "Report2"，點擊「解析工作表」。
   - 確認報表顯示 IP、帳號、連線數。

## 使用方法

1. 訪問 GitHub Pages 網址。
2. 點擊「上傳 Excel 檔案」，選擇 `AFLog-20250508-010229.xls`。
3. 從「選擇工作表」下拉選單選擇 "Report2"。
4. 點擊「解析工作表」。
5. 報表應顯示：
   - **表格**：IP 地址、帳號與姓名、連線總數。
   - **摘要**：總流量（572）、總連線數（633）、觀察。
6. 若報表未顯示，檢查錯誤訊息並參考「問題排查」。

## 問題排查

若顯示「未找到有效的 Top主機 資料」，請檢查：

1. **控制台日誌**：
   - 按 F12 開啟「Console」。
   - 上傳檔案並解析 "Report2"，複製日誌（JSON 資料、行處理、錯誤訊息）。
   - 分享日誌以診斷問題。

2. **驗證 Excel 檔案**：
   - 打開 `AFLog-20250508-010229.xls`，檢查 "Report2"：
     - 第一行：標題（`編號 主機 總連線數`）。
     - 資料行：
       - 第一列：編號（例如 `1`, `2`）。
       - 第二列：IP 或 IP-帳號（例如 `10.101.16.195-10007643-Ian Lu...`）。
       - 第三列：連線數（例如 `110`）。
     - 最後：`總流量` 和 `Total`。
   - 確認無額外空白行或標題。

3. **測試範例檔案**：
   - 創建 `test.xlsx`，包含以下資料（工作表名 "Report2"）：
     ```
     編號 主機 總連線數
     1 10.101.16.195-10007643-Ian Lu (QA_DQE-盧宗彯)... 110
     2 10.101.12.42 108
     3 10.101.16.187-10007063-Joe Liao (ACC-RD2-RF-廖偉盛)... 96
     總流量 572
     Total 633
     ```
   - 上傳並選擇 "Report2"，確認報表。

4. **檢查 CDN**：
   - 確保可訪問：
     - `https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js`
     - `https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js`
     - `https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js`
     - `https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js`
   - 若失敗，下載至 `libs` 目錄，更新 `index.html` 使用本地路徑。

5. **重新部署**：
   ```bash
   git add index.html README.md
   git commit -m "修復解析問題"
   git push origin main
   ```
   - 清除瀏覽器快取（Ctrl+Shift+R）並重新訪問。

## 注意事項

- **Excel 格式**：確保 "Report2" 包含正確的「Top主機」資料。
- **工作表選擇**：選擇 "Report2"。Report0 和 Report1 包含其他資料（Top用戶、Top中繼站）。
- **報表保存**：報表僅顯示於網頁，可手動複製或另存為 HTML。
